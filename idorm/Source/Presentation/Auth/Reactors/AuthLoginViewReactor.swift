//
//  LoginViewReactor.swift
//  idorm
//
//  Created by ÍπÄÏùëÏ≤† on 2022/12/21.
//

import Foundation
import OSLog

import RxSwift
import RxCocoa
import RxMoya
import ReactorKit

final class AuthLoginViewReactor: Reactor {
  
  enum Action {
    case loginButtonDidTap
    case emailTextFieldDidChange(String)
    case passwordTextFieldDidChange(String)
    case signUpButtonDidTap
    case forgotPasswordButtonDidTap
  }
  
  enum Mutation {
    case setEmail(String)
    case setPassword(String)
    case setTabBarVC(Bool)
    case setEmailVC(AuthProcess)
  }
  
  struct State {
    var email: String = ""
    var password: String = ""
    @Pulse var shouldPresentToTabBarVC: Bool = false
    @Pulse var shouldNavigateToEmailVC: AuthProcess?
  }
  
  // MARK: - Properties
  
  var initialState: State = State()
  private let memberNetworkService = NetworkService<MemberAPI>()
  private let matchingInfoNetworkService = NetworkService<MatchingInfoAPI>()
  
  // MARK: - Functions
  
  func mutate(action: Action) -> Observable<Mutation> {
    switch action {
    case .emailTextFieldDidChange(let email):
      return .just(.setEmail(email))
      
    case .passwordTextFieldDidChange(let password):
      return .just(.setPassword(password))
      
    case .loginButtonDidTap:
      let email = self.currentState.email
      let password = self.currentState.password
      return self.memberNetworkService.requestAPI(to: .login(
        email: email,
        password: password
      ))
      .flatMap { response in
        let responseDTO = NetworkUtility.decode(
          ResponseDTO<MemberSingleResponseDTO>.self,
          data: response.data
        ).data
        let token = response.response?.headers["authorization"]
        // Î©§Î≤ÑÏùò Ï†ïÎ≥¥Î•º Ï†ÄÏû•Ìï©ÎãàÎã§.
        UserStorage.shared.member = Member(responseDTO)
        // Î©§Î≤ÑÏùò ÌÜ†ÌÅ∞ÏùÑ Ï†ÄÏû•Ìï©ÎãàÎã§.
        UserStorage.shared.token = token!
        os_log(.info, "üîì Î°úÍ∑∏Ïù∏Ïóê ÏÑ±Í≥µÌïòÏòÄÏäµÎãàÎã§. Ïù¥Î©îÏùº: \(email), ÎπÑÎ∞ÄÎ≤àÌò∏: \(password)")
        return self.requestMatchingInfo()
      }
      .catch { error in 
        os_log(.error, "üîê Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§. Ïù¥Î©îÏùº: \(email), ÎπÑÎ∞ÄÎ≤àÌò∏: \(password), Ïã§Ìå®ÏöîÏù∏: \(error.localizedDescription)")
        return .empty()
      }
      
    case .forgotPasswordButtonDidTap:
      return .just(.setEmailVC(.findPw))
      
    case .signUpButtonDidTap:
      return .just(.setEmailVC(.signUp))
    }
  }
  
  func reduce(state: State, mutation: Mutation) -> State {
    var newState = state
    
    switch mutation {
    case .setEmail(let email):
      newState.email = email
      
    case .setPassword(let password):
      newState.password = password
       
    case .setEmailVC(let authProcess):
      newState.shouldNavigateToEmailVC = authProcess
      
    case .setTabBarVC(let state):
      newState.shouldPresentToTabBarVC = state
    }
    
    return newState
  }
}

// MARK: - Privates

private extension AuthLoginViewReactor {
  func requestMatchingInfo() -> Observable<Mutation> {
    return self.matchingInfoNetworkService.requestAPI(to: .getMatchingInfo)
      .map(ResponseDTO<MatchingInfoResponseDTO>.self)
      .flatMap { responseDTO in
        // Îß§Ïπ≠ Ï†ïÎ≥¥ Ï†ÄÏû•
        UserStorage.shared.matchingInfo = MatchingInfo(responseDTO.data)
        return Observable<Mutation>.just(.setTabBarVC(true))
      }
  }
}
